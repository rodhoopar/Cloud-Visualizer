<!doctype html>
<html>
<head>
  <title>Dropbox Visualizer</title>
  <script src="dropbox.min.js"></script>
  <script src="kloudless.explorer.js"></script>
  <script src="jquery.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="http://code.jquery.com/ui/1.12.0/jquery-ui.min.js"> </script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
  <style>
    .node {
      pointer-events: all;
      stroke: #000000;
      stroke-width: 1.5px;
    }

    .link {
      stroke: #cd9cff;
      stroke-width: 1.5px;
    }

    .ui-autocomplete {
      max-height: 200px;
      max-width: 200px;
      overflow-y: auto;
      overflow-x: hidden;
    }
</style>
</head>
<body>
  <div class="ui-widget">
    <button id="file-explorer">Start a new visualization!</button><br>
    <input id="search">
    <button type="button" onclick="search()">Search</button>
  </div>
  <svg width="1110" height="535"></svg>
  <script>
    var KLOUDLESS_APPID = "gydGdNqH2Q7JzMYZIYwL_nH6oUMSMCOIB8JSzJsbnHk5L9iS";
    var KLOUDLESS_TOKEN = "miJq3YNWumvWjX93ISCe18EFnZxtzw";
    var selected = "";
    var nodes = [];
    function node(id, size, type, start, name, modified, path) {
      this.id = id;
      this.size = size;
      this.type = type;
      this.start = start;
      this.name = name;
      this.modified = modified;
      this.path = path;
    }
    var links = [];
    function link(source, target) {
      this.source = source;
      this.target = target;
    }
    var present = false; 

    function kloudless_populate() {
      var explorer = window.Kloudless.explorer({
        app_id: KLOUDLESS_APPID,
        multiselect: false,
        link: true,
        create_folder: false,
        types: ['folders']
      });
      explorer.choosify(document.getElementById('file-explorer'));
      explorer.on('success', function(folder) {
        selected = folder[0];
        nodes = [];
        links = [];
        nodes.push(new node(selected.id, null, "folder", true, selected.name, selected.modified, selected.path));
        populate(selected.id);
        clear_svg();
        display();
      });
    }
    kloudless_populate();

    function list_children(id) {
      var url = "https://api.kloudless.com/v0/accounts/166603373/folders/" + id + "/contents";
      var xhttp = new XMLHttpRequest();
      xhttp.open("GET", url, false);
      xhttp.setRequestHeader("Authorization", "Bearer " + KLOUDLESS_TOKEN);
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send();
      return JSON.parse(xhttp.responseText).objects;
    }

    function get_file_metadata(id) {
      var url = "https://api.kloudless.com/v0/accounts/166603373/files/" + id;
      var xhttp = new XMLHttpRequest();
      xhttp.open("GET", url, false);
      xhttp.setRequestHeader("Authorization", "Bearer " + KLOUDLESS_TOKEN);
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send();
      return JSON.parse(xhttp.responseText);
    }

    function get_folder_metadata(id) {
      var url = "https://api.kloudless.com/v0/accounts/166603373/folders/" + id;
      var xhttp = new XMLHttpRequest();
      xhttp.open("GET", url, false);
      xhttp.setRequestHeader("Authorization", "Bearer " + KLOUDLESS_TOKEN);
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send();
      return JSON.parse(xhttp.responseText);
    }

    function populate(startId) {
      var children = list_children(startId);
      if (children) {
        for (var i = 0; i < children.length; i++) {
          nodes.push(new node(children[i].id, children[i].size, children[i].type, false, children[i].name, children[i].modified, children[i].path));
          links.push(new link(startId, children[i].id));
          if (children[i].type === "folder") {
            populate(children[i].id);
          }
        }
      }
    }

    function print() {
      console.log(JSON.stringify(nodes));
      console.log(JSON.stringify(links));
    }

    function display() {
      var svg = d3.select("svg");
      var width = svg.attr("width");
      var height = svg.attr("height");

      var force = d3.forceSimulation()
        .force("charge", d3.forceManyBody().strength(-150))
        .force("link", d3.forceLink().id(function(d) { return d.id }).distance(15))
        .force("x", d3.forceX(width/2))
        .force("y", d3.forceY(height/2))

      var link = svg.append("g")
        .selectAll(".link")
        .data(links)
        .enter().append("line")
        .attr("class", "link");

      var node = svg.append("g")
        .selectAll(".node")
        .data(nodes)
        .enter().append("circle")
          .attr("class", "node")
          .attr("r", function(d) { return (d.size == null) ? 7 : d.size/20000 })
          .style("fill", function(d) {
            if (d.start) return "#ff9cce";
            else if (d.type === "folder") return "#9cceff";
            else return "#ceff9c";
          })
          .on("mouseover", modify(.1, 5))
          .on("mouseout", modify(1, 0))
          .call(d3.drag()
            .on("start", startdrag)
            .on("drag", dragging )
            .on("end", enddrag));

      node.append("title")
        .text(function (d) {
          var title = "Name: " + d.name;
          title += "\n\nSize: ";
          if (d.size != null) {
            title += (d.size/1024).toFixed(2) + " KB";
          }
          else title += "Folder";
          title += "\n\nModified: "
          if (d.modified != null) {
            title += d.modified.substring(0, 10);
          }
          else title += "N/A";
          title += "\n\nPath: " + d.path;
          return title;
        });

      force
        .nodes(nodes)
        .on("tick", tick)
        .force("link")
          .links(links);

      var linkedByIndex = {};
      links.forEach(function(d) {
          linkedByIndex[d.source.index + "," + d.target.index] = 1;
      });

      function isConnected(a, b) {
          return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
      }

      function isChild(a, b) {
          return linkedByIndex[a.index + "," + b.index] || a.index == b.index;
      }

      function tick() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
      }

      function modify(opacity, size) {
        return function(d) {
          node.style("stroke-opacity", function(o) {
              thisOpacity = isConnected(d, o) ? 1 : opacity;
              this.setAttribute('fill-opacity', thisOpacity);
              return thisOpacity;
          });

          link.style("stroke-opacity", function(o) {
              return o.source === d || o.target === d ? 1 : opacity;
          });

          d3.select(this)
          .transition()
          .duration(150)
          .attr("r", function(d) { return (d.size == null) ? 7 + size : d.size/20000 + size });
        };
      }

      function startdrag(d) {
        if (!d3.event.active) {
          force.alphaTarget(0.25).restart();
        }
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragging(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function enddrag(d) {
        if (!d3.event.active) {
          force.alphaTarget(0);
        }
        d.fx = null;
        d.fy = null;
      }

      var optArray = [];
      for (var i = 0; i < nodes.length; i++) {
          optArray.push(nodes[i].name);
      }
      optArray = optArray.sort();
      $(function () {
          $("#search").autocomplete({
              source: optArray
          });
      });

      this.search = function() {
        var selectedVal = document.getElementById('search').value;
        var node = svg.selectAll(".node");
        if (selectedVal != "") {
          var selected = node.filter(function (d, i) {
              return d.name != selectedVal;
          });
          if (selected["_groups"][0].length != node["_groups"][0].length) {
            selected.style("opacity", "0");
            var link = svg.selectAll(".link")
            link.style("opacity", "0");
            d3.selectAll(".node, .link").transition()
                .duration(5000)
                .style("opacity", 1);
          }
        }
      }
    }

    function search() {
      var searcher = new display()
      searcher.search();
    }

    function clear_svg() {
      var svg = d3.select("svg");
      svg.selectAll("*").remove();
    }
  </script>
</body>
</html>